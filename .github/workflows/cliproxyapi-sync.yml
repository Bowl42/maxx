name: CLIProxyAPI Sync

on:
  schedule:
    - cron: "17 2 * * 1"
  workflow_dispatch:
  workflow_call:
    secrets:
      HOMEBREW_TAP_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: cliproxyapi-sync-and-replace-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync-cliproxyapi-fork:
    name: Sync CLIProxyAPI fork (rebase + push)
    runs-on: ubuntu-latest
    outputs:
      fork_changed: ${{ steps.sync.outputs.fork_changed }}
    steps:
      - name: Checkout awsl-project/CLIProxyAPI
        uses: actions/checkout@v4
        with:
          repository: awsl-project/CLIProxyAPI
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Rebase with upstream and push
        id: sync
        run: |
          TARGET_BRANCH="main"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin "$TARGET_BRANCH"
          git checkout -B "$TARGET_BRANCH" "origin/$TARGET_BRANCH"

          git remote add upstream https://github.com/router-for-me/CLIProxyAPI.git
          git fetch upstream "$TARGET_BRANCH"

          BEFORE=$(git rev-parse HEAD)
          UPSTREAM_SHA=$(git rev-parse "upstream/$TARGET_BRANCH")

          if [ "$BEFORE" = "$UPSTREAM_SHA" ]; then
            echo "No upstream changes"
            echo "fork_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git pull --rebase upstream "$TARGET_BRANCH"
          git push origin "$TARGET_BRANCH"
          echo "fork_changed=true" >> "$GITHUB_OUTPUT"

  deps-update:
    name: Update maxx CLIProxyAPI replace
    runs-on: ubuntu-latest
    needs: sync-cliproxyapi-fork
    if: ${{ needs.sync-cliproxyapi-fork.outputs.fork_changed == 'true' }}
    steps:
      - name: Checkout maxx
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Update replace to latest
        run: |
          go mod edit -replace=github.com/router-for-me/CLIProxyAPI/v6=github.com/awsl-project/CLIProxyAPI/v6@latest
          go mod tidy

      - name: Create PR with gh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BASE_BRANCH="main"
          BRANCH="chore/cliproxyapi-replace-update"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin "$BASE_BRANCH"
          git checkout -B "$BRANCH" "origin/$BASE_BRANCH"
          git add go.mod go.sum

          if git diff --cached --quiet; then
            echo "No dependency changes"
            exit 0
          fi

          git commit -m "chore: update CLIProxyAPI replace"
          git push -f origin "$BRANCH"

          PR_NUMBER=$(gh pr list \
            --base "$BASE_BRANCH" \
            --head "$BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "PR already exists: #$PR_NUMBER"
            exit 0
          fi

          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$BRANCH" \
            --title "chore: update CLIProxyAPI replace" \
            --body "Automated dependency update by CLIProxyAPI Sync workflow."
